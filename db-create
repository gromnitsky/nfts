#!/usr/bin/make -f

out := _out
cache := $(out)/.cache
src :=

src.all := $(wildcard $(src)/*.html $(src)/*.markdown)
src.html := $(filter %.html, $(src.all))
src.markdown := $(filter %.markdown, $(src.all))

sql := $(patsubst $(src)/%.html, $(cache)/%.sql, $(src.html)) \
	$(patsubst $(src)/%.markdown, $(cache)/%.sql, $(src.markdown))

$(if $(firstword $(sql)),,$(error valid src= is required))

$(out)/db.sqlite3: $(sql)
	-rm $@
	sqlite3 $@ 'CREATE VIRTUAL TABLE fts USING fts5(file UNINDEXED, title UNINDEXED, date UNINDEXED, body)'
	sqlite3 $@ 'CREATE TABLE metatags(file, type, name)'
	cat $^ | sqlite3 $@

$(cache)/%.sql: $(src)/%.markdown
	$(sql-insert)

$(cache)/%.sql: $(src)/%.html
	$(sql-insert)

define sql-insert =
@mkdir -p $(dir $@)
./sql-insert $< > $@
endef

.DELETE_ON_ERROR:
