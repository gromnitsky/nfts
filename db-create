#!/usr/bin/make -f

out := _out
cache := $(out)/.cache
mk := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))
src :=

$(if $(firstword $(src)),,$(error valid src= is required))

src.all := $(foreach dir,$(src),$(shell find $(dir)/ -type f -name '*.html' -or -name '*.markdown' -or -name '*.md'))
sql := $(patsubst %, $(cache)/%.sql, $(src.all))

$(if $(firstword $(sql)),,$(error no files found; check src=))

$(out)/db.sqlite3: $(sql)
	-rm $@
	sqlite3 $@ 'CREATE VIRTUAL TABLE fts USING fts5(file UNINDEXED, title UNINDEXED, date UNINDEXED, body)'
	sqlite3 $@ 'CREATE TABLE metatags(file, type, name)'
	cat $^ | sqlite3 $@

$(cache)/%.sql: %
	@mkdir -p $(dir $@)
	$(mk)/sql-insert $< > $@

.DELETE_ON_ERROR:
