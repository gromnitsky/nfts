#!/usr/bin/make -f

out := _out
cache := $(out)/.cache
src :=

src.all := $(shell find $(src)/ -type f -name '*.html' -or -name '*.markdown' -or -name '*.md')
sql := $(patsubst $(src)/%, $(cache)/%.sql, $(src.all))

$(if $(firstword $(sql)),,$(error valid src= is required))

$(out)/db.sqlite3: $(sql)
	-rm $@
	sqlite3 $@ 'CREATE VIRTUAL TABLE fts USING fts5(file UNINDEXED, title UNINDEXED, date UNINDEXED, body)'
	sqlite3 $@ 'CREATE TABLE metatags(file, type, name)'
	cat $^ | sqlite3 $@

$(cache)/%.sql: $(src)/%
	@mkdir -p $(dir $@)
	./sql-insert $< > $@

.DELETE_ON_ERROR:
